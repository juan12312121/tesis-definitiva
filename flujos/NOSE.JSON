{
  "name": "Tesis - Chatbot WhatsApp - REFACTORIZADO CON CANCELACIÃ“N",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-mensaje",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -32,
        128
      ],
      "id": "7a954181-6289-47b3-a8b3-97c748542e65",
      "name": "Webhook",
      "webhookId": "7c272506-5f62-456f-a7c2-9dd935c3ec22"
    },
    {
      "parameters": {
        "url": "http://host.docker.internal:3000/api/whatsapp/public/configuracion-chatbot",
        "sendQuery": true,
        "specifyQuery": "json",
        "jsonQuery": "={\n  \"empresaId\": {{ JSON.stringify($json.body.empresaId) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        128,
        128
      ],
      "id": "2628fe38-1be1-4bc3-9a65-b5f6deb97a00",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "msg-usuario",
              "name": "mensaje_usuario",
              "value": "={{ $('Webhook').item.json.body.mensaje }}",
              "type": "string"
            },
            {
              "id": "session-key",
              "name": "nombreSesion",
              "value": "={{ $('HTTP Request').first().json.sessionKey }}",
              "type": "string"
            },
            {
              "id": "empresa-id",
              "name": "empresaId",
              "value": "={{ $('Webhook').item.json.body.empresaId }}",
              "type": "string"
            },
            {
              "id": "push-name",
              "name": "pushName",
              "value": "={{ $('Webhook').item.json.body.pushName }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        288,
        128
      ],
      "id": "e5d2e320-a2f7-4c59-b95e-4ac5cb62fce9",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Webhook').first().json.body.mensaje }}",
        "options": {
          "systemMessage": "Eres un clasificador de contexto para un chatbot de ventas por WhatsApp.\n\nTu tarea: Determinar si el mensaje del usuario requiere respuesta del bot de ventas.\n\n=== MENSAJES EN_CONTEXTO (el bot DEBE responder) ===\nâœ… Consultas sobre productos/catÃ¡logo (cualquier variaciÃ³n):\n   - \"productos\", \"quÃ© venden\", \"menu\", \"catÃ¡logo\"\n   - \"ver productos\", \"mostrar productos\"\n   - \"que tienen\", \"que hay\"\n\nâœ… Horarios de atenciÃ³n (cualquier variaciÃ³n):\n   - \"horario\", \"horarios\", \"estÃ¡n abiertos\"\n   - \"a quÃ© hora cierran\", \"a quÃ© hora abren\"\n   - \"cuando abren\", \"cuando cierran\", \"que hora\"\n\nâœ… Pedidos - TODAS LAS VARIACIONES:\n   - \"mis pedidos\", \"pedidos\", \"historial\"\n   - \"ver mis pedidos\", \"ver pedidos\"\n   - \"puedo ver mis pedidos\", \"quiero ver mis pedidos\"\n   - \"consultar pedidos\", \"revisar pedidos\"\n   - \"mis compras\", \"ver mis compras\"\n   - \"historial de pedidos\", \"mis Ã³rdenes\"\n\nâœ… Cancelar pedidos - TODAS LAS VARIACIONES:\n   - \"cancelar\", \"cancelar pedido\"\n   - \"cancelar pedido #5\", \"cancelar pedido 5\"\n   - \"quiero cancelar\", \"cancelar orden\"\n   - Solo la palabra \"cancelar\"\n   - \"cancela pedido\", \"cancela\"\n\nâœ… Disponibilidad de productos (\"tienen X disponible\")\nâœ… AtenciÃ³n al cliente y soporte\nâœ… UbicaciÃ³n del negocio (\"dÃ³nde estÃ¡n\", \"direcciÃ³n\")\nâœ… Precios (\"cuÃ¡nto cuesta\", \"precio de X\")\nâœ… Preguntas generales del negocio\n\nâœ… Pedidos en formato vÃ¡lido:\n   - \"1,2\" (producto 1, cantidad 2)\n   - \"1,2;3,1\" (mÃºltiples productos)\n   - Cualquier patrÃ³n nÃºmero,nÃºmero\n\nâœ… ConfirmaciÃ³n de nombre para pedido (cuando ya hay pedido activo)\nâœ… Saludos bÃ¡sicos de inicio (\"hola\", \"buenos dÃ­as\", \"buenas tardes\")\nâœ… Palabras clave de confirmaciÃ³n: \"sÃ­\", \"no\" (en contexto de sesiones activas)\n\n=== MENSAJES FUERA_CONTEXTO (el bot NO debe responder) ===\nâŒ Conversaciones personales entre personas fÃ­sicas\nâŒ Saludos dirigidos a personas especÃ­ficas (\"hola Juan\", \"quÃ© onda compa\")\nâŒ Temas sentimentales o romÃ¡nticos\nâŒ PlÃ¡ticas casuales de amigos/familia\nâŒ Bromas internas, memes, stickers sin contexto de negocio\nâŒ Temas polÃ­ticos, religiosos, deportivos (sin relaciÃ³n al negocio)\nâŒ Mensajes claramente para otra persona\nâŒ Spam o publicidad de otros negocios\nâŒ Contenido ofensivo o inapropiado\n\n=== CASOS ESPECIALES ===\n- \"Hola\" solo â†’ EN_CONTEXTO (puede ser inicio de compra)\n- \"Hola, cÃ³mo estÃ¡s\" con nombre â†’ FUERA_CONTEXTO (conversaciÃ³n personal)\n- NÃºmeros solos sin comas (ej: \"123456\") â†’ FUERA_CONTEXTO (puede ser telÃ©fono/cÃ³digo)\n- Formato pedido vÃ¡lido (\"1,2\") â†’ SIEMPRE EN_CONTEXTO\n- \"mis pedidos\" / \"ver mis pedidos\" / \"puedo ver mis pedidos\" â†’ SIEMPRE EN_CONTEXTO\n- \"cancelar pedido #5\" â†’ SIEMPRE EN_CONTEXTO\n- \"cancelar\" solo â†’ SIEMPRE EN_CONTEXTO (puede haber sesiÃ³n activa)\n- \"sÃ­\" / \"si\" / \"no\" solos â†’ SIEMPRE EN_CONTEXTO (pueden ser confirmaciones)\n\n=== INSTRUCCIONES DE RESPUESTA ===\nAnaliza el mensaje y responde ÃšNICAMENTE con una de estas dos palabras:\n\"EN_CONTEXTO\" o \"FUERA_CONTEXTO\"\n\nNo agregues explicaciones, puntuaciÃ³n ni texto adicional.\nSolo la palabra exacta.\n\nIMPORTANTE: Cualquier mensaje que mencione \"pedidos\", \"mis pedidos\", \"ver pedidos\", \"historial\", \"cancelar\", \"compras\" debe ser clasificado como EN_CONTEXTO sin excepciÃ³n."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        464,
        128
      ],
      "id": "8582aa11-2fc4-4dcb-8878-b4a6d18ab5d7",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-contexto",
              "leftValue": "={{ $json.output }}",
              "rightValue": "EN_CONTEXTO",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        768,
        128
      ],
      "id": "c88ebd97-dafc-4c47-86e2-a87597c034b5",
      "name": "If"
    },
    {
      "parameters": {
        "model": "llama-3.3-70b-versatile",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
      "typeVersion": 1,
      "position": [
        512,
        384
      ],
      "id": "b7a3c1ab-0f9d-4809-a292-30630df3bc00",
      "name": "Groq Chat Model",
      "credentials": {
        "groqApi": {
          "id": "wFuRBaNBnwrhjYlY",
          "name": "Groq account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const config = $('HTTP Request').first().json;\nconst webhook = $('Webhook').first().json.body;\n\nconst ZONA_HORARIA = 'America/Hermosillo';\nconst now = new Date();\nconst horaLocal = new Date(now.toLocaleString('en-US', { timeZone: ZONA_HORARIA }));\nconst hour = horaLocal.getHours();\nconst day = horaLocal.getDay();\n\nconst horaInicio = config.horario_inicio \n  ? parseInt(config.horario_inicio.split(':')[0]) \n  : (config.hora_inicio || 9);\n\nconst horaFin = config.horario_fin \n  ? parseInt(config.horario_fin.split(':')[0]) \n  : (config.hora_fin || 18);\n\nlet diasLaborales = [1, 2, 3, 4, 5];\nif (config.dias_laborales) {\n  try {\n    diasLaborales = typeof config.dias_laborales === 'string' \n      ? JSON.parse(config.dias_laborales) \n      : config.dias_laborales;\n  } catch (e) {\n    console.log('âš ï¸ Error parseando dias_laborales:', e.message);\n  }\n}\n\nconst enDiaLaboral = diasLaborales.includes(day);\nconst enHorario = hour >= horaInicio && hour < horaFin;\nconst abierto = enDiaLaboral && enHorario;\n\nconst mensaje = webhook.mensaje || '';\nconst mensajeLimpio = mensaje.toLowerCase().trim();\n\nlet nombreSesion = config.sessionKey || \n                   webhook.sessionKey || \n                   `${webhook.empresaId}_empresa_${webhook.empresaId}`;\n\nif (nombreSesion && nombreSesion.startsWith(`${webhook.empresaId}_`)) {\n  nombreSesion = nombreSesion.substring(`${webhook.empresaId}_`.length);\n}\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('ğŸ¯ MENSAJE RECIBIDO:', mensajeLimpio);\nconsole.log('ğŸ“ Usuario:', webhook.numeroOrigen);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ PRIORIDAD 1: CANCELAR PEDIDO ESPECÃFICO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst patronCancelarEspecifico = /\\b(?:cancelar|cancela)\\s+(?:pedido|orden)\\s*#?(\\d+)\\b/i;\nconst matchCancelarEspecifico = mensajeLimpio.match(patronCancelarEspecifico);\n\nif (matchCancelarEspecifico) {\n  const pedidoId = matchCancelarEspecifico[1];\n  console.log(`ğŸ¯ DETECTADO: Cancelar pedido especÃ­fico #${pedidoId}`);\n  \n  return {\n    json: {\n      ...config,\n      numeroOrigen: webhook.numeroOrigen,\n      empresaId: webhook.empresaId,\n      nombreSesion: nombreSesion,\n      pushName: webhook.pushName,\n      mensaje_usuario: mensajeLimpio,\n      pedidoId: parseInt(pedidoId),\n      tipo: 'cancelar_pedido',\n      mensaje: `ğŸ”„ *Procesando cancelaciÃ³n del pedido #${pedidoId}...*`,\n      abierto: abierto\n    }\n  };\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ PRIORIDAD 2: VER PEDIDOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst patronCancelarGeneral = /^(?:cancelar|cancela)$/i;\nconst esCancelarGeneral = patronCancelarGeneral.test(mensajeLimpio);\n\nif (!esCancelarGeneral) {\n  const patronVerPedidos = /\\b(mis?\\s+pedidos?|ver\\s+mis?\\s+pedidos?|pedidos?|historial|mis?\\s+compras?|ver\\s+compras?|consultar\\s+pedidos?|revisar\\s+pedidos?|puedo\\s+ver\\s+mis?\\s+pedidos?|quiero\\s+ver\\s+mis?\\s+pedidos?)\\b/i;\n\n  if (patronVerPedidos.test(mensajeLimpio)) {\n    console.log('âœ… DETECTADO: Ver pedidos');\n    \n    return {\n      json: {\n        ...config,\n        numeroOrigen: webhook.numeroOrigen,\n        empresaId: webhook.empresaId,\n        nombreSesion: nombreSesion,\n        pushName: webhook.pushName,\n        mensaje_usuario: mensajeLimpio,\n        tipo: 'ver_pedidos',\n        mensaje: 'ğŸ“‹ *Consultando tus pedidos...*',\n        abierto: abierto\n      }\n    };\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PRIORIDAD 3: Verificar sesiÃ³n de pedido temporal\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\ntry {\n  const sesionResponse = await fetch(`http://host.docker.internal:3000/api/pedidos/sesion/${webhook.empresaId}/${webhook.numeroOrigen}`, {\n    method: 'GET',\n    headers: {\n      'Content-Type': 'application/json'\n    }\n  });\n  \n  if (sesionResponse.ok) {\n    const sesionData = await sesionResponse.json();\n    \n    if (sesionData.success && sesionData.data) {\n      const estadoActual = sesionData.data.estado;\n      console.log('ğŸ“‹ SesiÃ³n temporal encontrada - Estado:', estadoActual);\n      \n      if (estadoActual === 'confirmar_cancelacion') {\n        if (mensajeLimpio === 'si' || mensajeLimpio === 'sÃ­') {\n          await fetch(`http://host.docker.internal:3000/api/pedidos/sesion/${webhook.empresaId}/${webhook.numeroOrigen}`, {\n            method: 'DELETE'\n          });\n          \n          return {\n            json: {\n              ...config,\n              numeroOrigen: webhook.numeroOrigen,\n              empresaId: webhook.empresaId,\n              nombreSesion: nombreSesion,\n              pushName: webhook.pushName,\n              mensaje_usuario: mensajeLimpio,\n              mensaje: \"âŒ *Pedido cancelado exitosamente*\\n\\nâœ… Si cambias de opiniÃ³n, escribe *productos* para ver el catÃ¡logo.\",\n              tipo: 'respuesta_directa',\n              abierto: abierto\n            }\n          };\n        } else if (mensajeLimpio === 'no') {\n          await fetch(`http://host.docker.internal:3000/api/pedidos/sesion/${webhook.empresaId}/${webhook.numeroOrigen}`, {\n            method: 'PUT',\n            headers: {\n              'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({ estado: 'pendiente' })\n          });\n          \n          return {\n            json: {\n              ...config,\n              numeroOrigen: webhook.numeroOrigen,\n              empresaId: webhook.empresaId,\n              nombreSesion: nombreSesion,\n              pushName: webhook.pushName,\n              mensaje_usuario: mensajeLimpio,\n              mensaje: \"âœ… *Pedido conservado*\\n\\nğŸ“ Por favor, escribe tu *nombre completo* para confirmar el pedido.\\n\\nâŒ O escribe *cancelar* si cambias de opiniÃ³n.\",\n              tipo: 'respuesta_directa',\n              abierto: abierto\n            }\n          };\n        } else {\n          return {\n            json: {\n              ...config,\n              numeroOrigen: webhook.numeroOrigen,\n              empresaId: webhook.empresaId,\n              nombreSesion: nombreSesion,\n              pushName: webhook.pushName,\n              mensaje_usuario: mensajeLimpio,\n              mensaje: \"âš ï¸ *Respuesta no vÃ¡lida*\\n\\nâœ… Escribe *sÃ­* para cancelar el pedido\\nâŒ Escribe *no* para continuar\",\n              tipo: 'respuesta_directa',\n              abierto: abierto\n            }\n          };\n        }\n      }\n      \n      if (estadoActual === 'esperando_nombre') {\n        if (mensajeLimpio === 'cancelar') {\n          await fetch(`http://host.docker.internal:3000/api/pedidos/sesion/${webhook.empresaId}/${webhook.numeroOrigen}`, {\n            method: 'PUT',\n            headers: {\n              'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({ estado: 'confirmar_cancelacion' })\n          });\n          \n          return {\n            json: {\n              ...config,\n              numeroOrigen: webhook.numeroOrigen,\n              empresaId: webhook.empresaId,\n              nombreSesion: nombreSesion,\n              pushName: webhook.pushName,\n              mensaje_usuario: mensajeLimpio,\n              mensaje: \"âš ï¸ *Â¿EstÃ¡s seguro de cancelar tu pedido?*\\n\\nâœ… Escribe *sÃ­* para confirmar la cancelaciÃ³n\\nâŒ Escribe *no* para continuar con tu pedido\",\n              tipo: 'respuesta_directa',\n              abierto: abierto\n            }\n          };\n        }\n        \n        if (mensaje.trim().length < 3) {\n          return {\n            json: {\n              ...config,\n              numeroOrigen: webhook.numeroOrigen,\n              empresaId: webhook.empresaId,\n              nombreSesion: nombreSesion,\n              pushName: webhook.pushName,\n              mensaje_usuario: mensajeLimpio,\n              mensaje: \"âš ï¸ *Nombre muy corto*\\n\\nğŸ“ Por favor escribe tu nombre completo (mÃ­nimo 3 caracteres).\\n\\nâŒ O escribe *cancelar* para anular.\",\n              tipo: 'respuesta_directa',\n              abierto: abierto\n            }\n          };\n        }\n        \n        const datosPedido = typeof sesionData.data.datos_pedido === 'string' \n          ? JSON.parse(sesionData.data.datos_pedido) \n          : sesionData.data.datos_pedido;\n        \n        return {\n          json: {\n            ...config,\n            numeroOrigen: webhook.numeroOrigen,\n            empresaId: webhook.empresaId,\n            nombreSesion: nombreSesion,\n            pushName: webhook.pushName,\n            nombreCliente: mensaje.trim(),\n            items: datosPedido.items,\n            total: datosPedido.total,\n            tipo: 'crear_pedido',\n            mensaje: 'âœ… *Confirmando tu pedido...*',\n            mensaje_usuario: mensajeLimpio,\n            abierto: abierto\n          }\n        };\n      }\n    }\n  }\n} catch (error) {\n  console.log('â„¹ï¸ No hay sesiÃ³n de pedido activa');\n}\n\n// COMANDO CANCELAR (sin nÃºmero de pedido y sin sesiÃ³n)\nif (esCancelarGeneral) {\n  console.log('â„¹ï¸ Usuario escribiÃ³ \"cancelar\" sin sesiÃ³n activa');\n  return {\n    json: {\n      ...config,\n      numeroOrigen: webhook.numeroOrigen,\n      empresaId: webhook.empresaId,\n      nombreSesion: nombreSesion,\n      pushName: webhook.pushName,\n      mensaje_usuario: mensajeLimpio,\n      mensaje: \"â„¹ï¸ *No tienes ningÃºn pedido activo*\\n\\nğŸ“‹ Escribe *productos* para ver nuestro catÃ¡logo\\nğŸ›’ O escribe tu pedido directamente\\n\\nğŸ’¬ Â¿En quÃ© puedo ayudarte?\",\n      tipo: 'respuesta_directa',\n      abierto: abierto\n    }\n  };\n}\n\n// FORMATO DE PEDIDO\nconst patronPedido = /^\\d+,\\d+(;\\d+,\\d+)*$/;\nif (patronPedido.test(mensajeLimpio)) {\n  console.log('âœ… DETECTADO: Formato de pedido vÃ¡lido');\n  return {\n    json: {\n      ...config,\n      numeroOrigen: webhook.numeroOrigen,\n      empresaId: webhook.empresaId,\n      nombreSesion: nombreSesion,\n      pushName: webhook.pushName,\n      mensaje_usuario: mensajeLimpio,\n      tipo: 'procesar_pedido',\n      mensaje: 'ğŸ›’ *Procesando tu pedido...*',\n      abierto: abierto,\n      hora_actual: hour,\n      dia_actual: day\n    }\n  };\n}\n\n// FLUJO NORMAL - DETECTAR TIPO DE MENSAJE\nconst mensajeLower = mensajeLimpio.toLowerCase();\nlet tipoMensaje = 'fallback';\nlet mensajeRespuesta = '';\n\nconst saludos = ['hola', 'buenas', 'buenos dias', 'buenas tardes', 'buenas noches', 'buen dia', 'hey', 'ola', 'que tal', 'buenos dÃ­as'];\nif (saludos.some(s => mensajeLower.includes(s))) {\n  tipoMensaje = 'saludo_inicial';\n  mensajeRespuesta = '';\n}\nelse if (mensajeLower.includes(config.trigger_horarios || 'horario') || \n         mensajeLower.includes('hora') || \n         mensajeLower.includes('cuando abren') || \n         mensajeLower.includes('cuando cierran') ||\n         mensajeLower.includes('que hora') ||\n         mensajeLower.includes('a que hora')) {\n  tipoMensaje = 'mostrar_horario';\n  mensajeRespuesta = '';\n}\nelse if (mensajeLower.includes(config.trigger_productos || 'productos') || \n         mensajeLower.includes('catalogo') || \n         mensajeLower.includes('catÃ¡logo') || \n         mensajeLower.includes('que tienen') || \n         mensajeLower.includes('que venden') ||\n         mensajeLower.includes('menu') ||\n         mensajeLower.includes('menÃº') ||\n         mensajeLower.includes('ver productos')) {\n  tipoMensaje = 'productos';\n  mensajeRespuesta = '';\n}\nelse if (['si', 'sÃ­', 'ok', 'okey', 'vale', 'confirmar', 'confirmo', 'acepto', 'okay'].includes(mensajeLower)) {\n  tipoMensaje = 'respuesta_directa';\n  mensajeRespuesta = abierto \n    ? \"â„¹ï¸ *No tengo contexto de tu respuesta*\\n\\nÂ¿En quÃ© puedo ayudarte?\\n\\nğŸ“‹ Escribe *productos* para ver el catÃ¡logo\\nğŸ• Escribe *horarios* para ver horarios\"\n    : config.mensaje_fuera_horario;\n}\nelse if (mensajeLower.includes('ayuda') || mensajeLower.includes('opciones')) {\n  tipoMensaje = 'saludo_inicial';\n  mensajeRespuesta = '';\n}\nelse {\n  tipoMensaje = 'fallback';\n  mensajeRespuesta = abierto ? config.mensaje_horario : config.mensaje_fuera_horario;\n}\n\nconsole.log('ğŸ“¤ Resultado final - Tipo:', tipoMensaje);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nreturn {\n  json: {\n    ...config,\n    mensaje_usuario: mensajeLimpio,\n    numeroOrigen: webhook.numeroOrigen,\n    pushName: webhook.pushName,\n    empresaId: webhook.empresaId,\n    nombreSesion: nombreSesion,\n    conectado: config.conectado,\n    abierto: abierto,\n    hora_actual: hour,\n    dia_actual: day,\n    tipo: tipoMensaje,\n    mensaje: mensajeRespuesta || (abierto ? config.mensaje_horario : config.mensaje_fuera_horario),\n    mensaje_respuesta: abierto ? config.mensaje_horario : config.mensaje_fuera_horario\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        704
      ],
      "id": "b31900a8-9b5d-4949-8e67-4047453fe0d8",
      "name": "Validar y Clasificar"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "mostrar_horario",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mostrar_horario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "productos",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "productos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "procesar_pedido",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "procesar_pedido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "respuesta_directa",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "respuesta_directa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "saludo_inicial",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "saludo_inicial"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "ver_pedidos",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ver_pedidos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "crear_pedido",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_pedido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "cancelar_pedido",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar_pedido"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1328,
        592
      ],
      "id": "8d66cdad-d47d-4513-9bc5-cbdfdd77036b",
      "name": "Switch",
      "disabled": false
    },
    {
      "parameters": {
        "jsCode": "const config = $('HTTP Request').first().json;\nconst switchData = $('Switch').first().json;\n\nlet nombreSesion = switchData.nombreSesion;\nif (nombreSesion && nombreSesion.startsWith(`${switchData.empresaId}_`)) {\n  nombreSesion = nombreSesion.substring(`${switchData.empresaId}_`.length);\n}\n\nconst horaInicio = config.hora_inicio || 9;\nconst horaFin = config.hora_fin || 18;\nconst diasLaborales = config.dias_laborales || [1, 2, 3, 4, 5];\n\nconst nombresDias = {\n  0: 'Domingo',\n  1: 'Lunes',\n  2: 'Martes',\n  3: 'MiÃ©rcoles',\n  4: 'Jueves',\n  5: 'Viernes',\n  6: 'SÃ¡bado'\n};\n\nconst diasTexto = diasLaborales.map(d => nombresDias[d]).join(', ');\n\nconst mensaje = `ğŸ• *Horario de AtenciÃ³n*\\n\\nğŸ“… *DÃ­as laborales:*\\n${diasTexto}\\n\\nâ° *Horario:*\\n${horaInicio}:00 hrs - ${horaFin}:00 hrs\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\nğŸ’¬ Â¿En quÃ© mÃ¡s puedo ayudarte?\\n\\nğŸ“‹ Escribe *productos* para ver el catÃ¡logo\\nğŸ›’ O escribe tu pedido directamente`;\n\nreturn {\n  json: {\n    numeroOrigen: switchData.numeroOrigen,\n    empresaId: switchData.empresaId,\n    nombreSesion: nombreSesion,\n    mensaje: mensaje\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1824,
        208
      ],
      "id": "ae410f09-1a26-4c9d-a8fe-f1ee8e306fea",
      "name": "Mostrar Horario"
    },
    {
      "parameters": {
        "url": "=http://host.docker.internal:3000/api/catalogo/publico/{{ $json.empresaId }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1744,
        368
      ],
      "id": "756062a7-6238-4c00-a55e-8bd268c16bb5",
      "name": "Obtener productos catÃ¡logo"
    },
    {
      "parameters": {
        "jsCode": "const httpData = $input.first().json;\nconst switchData = $('Switch').first().json;\nconst productos = httpData.data;\n\nlet nombreSesion = switchData.nombreSesion;\nif (nombreSesion && nombreSesion.startsWith(`${switchData.empresaId}_`)) {\n  nombreSesion = nombreSesion.substring(`${switchData.empresaId}_`.length);\n}\n\nif (!productos || productos.length === 0) {\n  return {\n    numeroOrigen: switchData.numeroOrigen,\n    empresaId: switchData.empresaId,\n    nombreSesion: nombreSesion,\n    mensaje: \"ğŸ“¦ No hay productos disponibles actualmente.\",\n    productosConImagen: []\n  };\n}\n\nlet mensajeCompleto = 'ğŸ“¦ *CatÃ¡logo de Productos*\\n\\n';\nconst productosConImagen = [];\n\nproductos.forEach((p, i) => {\n  const numero = i + 1;\n  mensajeCompleto += `*${numero}.* ${p.nombre_item}\\n`;\n  \n  if (p.precio) {\n    const precio = parseFloat(p.precio).toFixed(2);\n    mensajeCompleto += `ğŸ’° Precio: ${precio}\\n`;\n  }\n  \n  if (p.descripcion) {\n    mensajeCompleto += `ğŸ“ ${p.descripcion}\\n`;\n  }\n  \n  mensajeCompleto += '\\n';\n  \n  if (p.imagen_url && p.imagen_url.trim() !== '' && p.imagen_url !== 'null' && p.imagen_url !== 'undefined') {\n    productosConImagen.push({\n      numero: numero,\n      nombre: p.nombre_item,\n      precio: p.precio ? `${parseFloat(p.precio).toFixed(2)}` : '',\n      descripcion: p.descripcion || '',\n      imagen_url: p.imagen_url\n    });\n  }\n});\n\nmensajeCompleto += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\nmensajeCompleto += `ğŸ›’ *Â¿Deseas hacer un pedido?*\\n\\n`;\nmensajeCompleto += `ğŸ“‹ Escribe el nÃºmero y cantidad:\\n`;\nmensajeCompleto += `ğŸ“Œ Ejemplo: *1,2* (2 unidades del producto 1)\\n\\n`;\nmensajeCompleto += `Para varios productos:\\n`;\nmensajeCompleto += `ğŸ“Œ Ejemplo: *1,2;3,1* (2 del prod.1 y 1 del prod.3)\\n\\n`;\nmensajeCompleto += `âœï¸ Escribe tu pedido ahora o *cancelar* para salir.`;\n\nreturn {\n  numeroOrigen: switchData.numeroOrigen,\n  empresaId: switchData.empresaId,\n  nombreSesion: nombreSesion,\n  pushName: switchData.pushName,\n  mensaje: mensajeCompleto,\n  productosConImagen: productosConImagen\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        368
      ],
      "id": "1d36b9b8-1a57-4144-b78e-d5073b65ad09",
      "name": "Formatear catÃ¡logo"
    },
    {
      "parameters": {
        "url": "=http://host.docker.internal:3000/api/catalogo/publico/{{ $json.empresaId }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1888,
        624
      ],
      "id": "21f21f5c-bcaf-4576-b983-655863a4c4a1",
      "name": "Obtener productos pedido"
    },
    {
      "parameters": {
        "jsCode": "const switchData = $('Switch').first().json;\nconst productosResponse = $input.first().json;\nconst productos = productosResponse.data;\n\nlet nombreSesion = switchData.nombreSesion;\nif (nombreSesion && nombreSesion.startsWith(`${switchData.empresaId}_`)) {\n  nombreSesion = nombreSesion.substring(`${switchData.empresaId}_`.length);\n}\n\nconst pedidoStr = switchData.mensaje_usuario;\n\nif (!pedidoStr || pedidoStr.trim() === '') {\n  return {\n    numeroOrigen: switchData.numeroOrigen,\n    empresaId: switchData.empresaId,\n    nombreSesion: nombreSesion,\n    pushName: switchData.pushName,\n    mensaje: \"âš ï¸ *Formato incorrecto*\\n\\nEscribe el nÃºmero del producto y la cantidad.\\n\\nğŸ“Œ Ejemplo: *1,2* (producto 1, cantidad 2)\",\n    tipo: 'error_formato'\n  };\n}\n\nconst pares = pedidoStr.split(';').map(p => p.trim()).filter(p => p);\nconst items = [];\nlet total = 0;\nlet errorMsg = '';\n\nfor (const par of pares) {\n  const partes = par.split(',').map(p => p.trim());\n  \n  if (partes.length !== 2) {\n    errorMsg = `âš ï¸ *Formato invÃ¡lido*\\n\\nEl formato correcto es:\\nğŸ“Œ *1,2* (producto 1, cantidad 2)`;\n    break;\n  }\n  \n  const [idStr, cantStr] = partes;\n  const id = parseInt(idStr);\n  const cantidad = parseInt(cantStr);\n  \n  if (isNaN(id) || isNaN(cantidad) || cantidad <= 0 || id <= 0) {\n    errorMsg = `âš ï¸ *Formato invÃ¡lido*\\n\\nEl formato correcto es:\\nğŸ“Œ *1,2* (producto 1, cantidad 2)`;\n    break;\n  }\n  \n  const producto = productos.find(p => p.id === id);\n  \n  if (!producto) {\n    errorMsg = `âš ï¸ *Producto no encontrado*\\n\\nEl producto #${id} no existe.\\n\\nğŸ“‹ Escribe *productos* para ver el catÃ¡logo.`;\n    break;\n  }\n  \n  if (!producto.precio || isNaN(parseFloat(producto.precio))) {\n    errorMsg = `âš ï¸ *Error en producto #${id}*\\n\\nEl producto no tiene precio vÃ¡lido.`;\n    break;\n  }\n  \n  const subtotal = parseFloat(producto.precio) * cantidad;\n  total += subtotal;\n  \n  items.push({\n    producto_id: producto.id,\n    nombre: producto.nombre_item,\n    cantidad: cantidad,\n    precio_unitario: parseFloat(producto.precio),\n    subtotal: subtotal\n  });\n}\n\nif (errorMsg) {\n  return {\n    numeroOrigen: switchData.numeroOrigen,\n    empresaId: switchData.empresaId,\n    nombreSesion: nombreSesion,\n    pushName: switchData.pushName,\n    mensaje: errorMsg,\n    tipo: 'error_pedido'\n  };\n}\n\nlet resumen = 'ğŸ›’ *Resumen de tu pedido:*\\n\\n';\nitems.forEach((item, i) => {\n  resumen += `${i + 1}. ${item.nombre}\\n`;\n  resumen += `   ğŸ’° ${item.precio_unitario.toFixed(2)} Ã— ${item.cantidad} = ${item.subtotal.toFixed(2)}\\n\\n`;\n});\nresumen += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n`;\nresumen += `ğŸ’µ *Total: ${total.toFixed(2)}*\\n\\n`;\nresumen += `ğŸ“ Por favor, escribe tu *nombre completo* para confirmar el pedido.\\n\\n`;\nresumen += `âŒ O escribe *cancelar* para anular.`;\n\nreturn {\n  numeroOrigen: switchData.numeroOrigen,\n  empresaId: switchData.empresaId,\n  nombreSesion: nombreSesion,\n  pushName: switchData.pushName,\n  mensaje: resumen,\n  tipo: 'pedir_nombre',\n  pedido_temporal: {\n    items: items,\n    total: total,\n    estado: 'esperando_nombre',\n    fecha_creacion: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2080,
        624
      ],
      "id": "e1aa813c-815a-4bbc-9966-7da6c60a5128",
      "name": "Procesar pedido"
    },
    {
      "parameters": {
        "jsCode": "const procesarData = $input.first().json;\nconst switchData = $('Switch').first().json;\nlet nombreSesion = switchData.nombreSesion;\n\nif (nombreSesion && nombreSesion.startsWith(`${switchData.empresaId}_`)) {\n  nombreSesion = nombreSesion.substring(`${switchData.empresaId}_`.length);\n}\n\nreturn {\n  json: {\n    numeroOrigen: switchData.numeroOrigen,\n    empresaId: switchData.empresaId,\n    nombreSesion: nombreSesion,\n    pushName: switchData.pushName,\n    mensaje: procesarData.mensaje,\n    pedido_temporal: procesarData.pedido_temporal,\n    tipo: procesarData.tipo,\n    abierto: !!switchData.abierto\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        624
      ],
      "id": "2af2fdd5-4858-482e-aebb-bb1d3600b379",
      "name": "Formatear pedido"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:3000/api/pedidos/sesion",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"empresaId\": {{ JSON.stringify($('Formatear pedido').first().json.empresaId) }},\n  \"numeroOrigen\": {{ JSON.stringify($('Formatear pedido').first().json.numeroOrigen || '') }},\n  \"nombreSesion\": {{ JSON.stringify($('Formatear pedido').first().json.nombreSesion || '') }},\n  \"pushName\": {{ JSON.stringify($('Formatear pedido').first().json.pushName || '') }},\n  \"estado\": {{ JSON.stringify($('Formatear pedido').first().json.tipo || '') }},\n  \"datosPedido\": {{ JSON.stringify($('Formatear pedido').first().json.pedido_temporal) }}\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2400,
        624
      ],
      "id": "0fb6fb00-d5f5-4333-bd71-54e7a5a14951",
      "name": "Guardar SesiÃ³n Temporal"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d2cf7f55-32ff-4616-a0c6-7e96df763b09",
              "name": "abierto",
              "value": "={{ !!$('Formatear pedido').first().json.abierto }}",
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2560,
        624
      ],
      "id": "8c41aa85-caa6-4e8e-8024-2b628ee76bbb",
      "name": "Recuperar"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-abierto",
              "leftValue": "={{ $json.abierto }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2736,
        624
      ],
      "id": "5789db67-977d-4776-9481-353b1d22f510",
      "name": "If horario"
    },
    {
      "parameters": {
        "jsCode": "const recuperarData = $json;\nconst formatData = $('Formatear pedido').first().json;\n\nreturn {\n  json: {\n    empresaId: formatData.empresaId,\n    nombreSesion: formatData.nombreSesion,\n    numeroOrigen: formatData.numeroOrigen,\n    mensaje: formatData.mensaje,\n    abierto: recuperarData.abierto\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3008,
        544
      ],
      "id": "bfd9344e-2520-4eaa-9087-a4b47742157a",
      "name": "Preparar whatsapp"
    },
    {
      "parameters": {
        "jsCode": "const config = $('HTTP Request').first().json;\nconst formatearData = $('Formatear pedido').first().json;\n\nlet nombreSesion = formatearData.nombreSesion;\nif (nombreSesion && nombreSesion.startsWith(`${formatearData.empresaId}_`)) {\n  nombreSesion = nombreSesion.substring(`${formatearData.empresaId}_`.length);\n}\n\nconst horaInicio = config.hora_inicio || 9;\nconst horaFin = config.hora_fin || 18;\n\nreturn {\n  json: {\n    numeroOrigen: formatearData.numeroOrigen,\n    empresaId: formatearData.empresaId,\n    nombreSesion: nombreSesion,\n    mensaje: `ğŸ”’ *Lo sentimos, estamos cerrados*\\n\\nâ° Nuestro horario de atenciÃ³n es:\\nğŸ“… Lunes a Viernes\\nğŸ• ${horaInicio}:00 hrs - ${horaFin}:00 hrs\\n\\nâŒ *No podemos procesar pedidos fuera de horario*\\n\\nâœ… Regresa en nuestro horario laboral para hacer tu pedido.\\n\\nğŸ“‹ Puedes escribir *horarios* para ver mÃ¡s informaciÃ³n.`\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3008,
        688
      ],
      "id": "2cf78dbd-acc3-4010-a439-38f2b562a1a0",
      "name": "Mensaje Pedido Fuera Horario"
    },
    {
      "parameters": {
        "jsCode": "const switchData = $input.first().json;\n\nreturn {\n  json: {\n    numeroOrigen: switchData.numeroOrigen,\n    empresaId: switchData.empresaId,\n    nombreSesion: switchData.nombreSesion,\n    mensaje: switchData.mensaje\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        800
      ],
      "id": "8cf362be-af26-44df-ad0b-6402aeb374fb",
      "name": "Respuesta Directa"
    },
    {
      "parameters": {
        "jsCode": "const codeData = $('Validar y Clasificar').first().json;\nconst webhookData = $('Webhook').first().json.body;\nconst nombreUsuario = webhookData.pushName || 'amigo';\n\nlet nombreSesion = codeData.nombreSesion;\nif (nombreSesion.startsWith(`${codeData.empresaId}_`)) {\n  nombreSesion = nombreSesion.substring(`${codeData.empresaId}_`.length);\n}\n\nreturn {\n  json: {\n    numeroOrigen: codeData.numeroOrigen,\n    empresaId: codeData.empresaId,\n    nombreSesion: nombreSesion,\n    mensaje: `ğŸ‘‹ Â¡Hola ${nombreUsuario}! Bienvenido(a)\\n\\nÂ¿En quÃ© puedo ayudarte hoy?\\n\\n1ï¸âƒ£ Escribe *horarios* para ver horarios de atenciÃ³n\\n2ï¸âƒ£ Escribe *productos* para ver nuestro catÃ¡logo\\n3ï¸âƒ£ Escribe *mis pedidos* para ver tus pedidos\\n\\nğŸ’¬ Â¿QuÃ© necesitas?`\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2208,
        944
      ],
      "id": "e7631074-bf27-4b7e-ada1-f9468027c72a",
      "name": "Saludo Inicial"
    },
    {
      "parameters": {
        "url": "=http://host.docker.internal:3000/api/pedidos/usuario/{{ $json.empresaId }}/{{ $json.numeroOrigen }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2096,
        1120
      ],
      "id": "aaad1bd1-ce63-459b-a039-a95f46fef7b7",
      "name": "Obtener pedidos"
    },
    {
      "parameters": {
        "jsCode": "const pedidosResponse = $input.first().json;\nconst switchData = $('Switch').first().json;\n\nconsole.log('ğŸ“‹ Respuesta de pedidos:', JSON.stringify(pedidosResponse, null, 2));\n\nif (!pedidosResponse.success || !pedidosResponse.data || pedidosResponse.data.length === 0) {\n  console.log('âŒ No hay pedidos para mostrar');\n  return {\n    json: {\n      numeroOrigen: switchData.numeroOrigen,\n      empresaId: switchData.empresaId,\n      nombreSesion: switchData.nombreSesion,\n      pushName: switchData.pushName,\n      mensaje: \"ğŸ“¦ *No tienes pedidos registrados*\\n\\nâœ… Escribe *productos* para ver el catÃ¡logo y hacer tu primer pedido.\"\n    }\n  };\n}\n\nconst pedidos = pedidosResponse.data;\nconsole.log(`âœ… Se encontraron ${pedidos.length} pedidos`);\n\nfunction formatearFecha(fechaISO) {\n  const fecha = new Date(fechaISO);\n  const opciones = {\n    day: '2-digit',\n    month: 'short',\n    year: 'numeric',\n    hour: '2-digit',\n    minute: '2-digit',\n    hour12: true\n  };\n  return fecha.toLocaleDateString('es-MX', opciones);\n}\n\nfunction formatearEstado(estado) {\n  const estados = {\n    'pendiente': 'â³ Pendiente',\n    'confirmado': 'âœ… Confirmado',\n    'en_proceso': 'ğŸ”„ En Proceso',\n    'entregado': 'ğŸ“¦ Entregado',\n    'cancelado': 'âŒ Cancelado'\n  };\n  return estados[estado] || estado;\n}\n\nlet mensaje = `ğŸ“‹ *Tus Pedidos (${pedidos.length})*\\n\\n`;\n\npedidos.forEach((pedido, index) => {\n  const fecha = formatearFecha(pedido.fecha_pedido);\n  const estado = formatearEstado(pedido.estado);\n  const total = parseFloat(pedido.total).toFixed(2);\n  \n  let emoji = 'â³';\n  if (pedido.estado === 'confirmado') emoji = 'âœ…';\n  if (pedido.estado === 'en_proceso') emoji = 'ğŸ”„';\n  if (pedido.estado === 'entregado') emoji = 'ğŸ“¦';\n  if (pedido.estado === 'cancelado') emoji = 'âŒ';\n  \n  mensaje += `${emoji} *Pedido #${pedido.id}*\\n`;\n  mensaje += `ğŸ“… ${fecha}\\n`;\n  mensaje += `ğŸ’µ Total: $${total}\\n`;\n  mensaje += `ğŸ“Š Estado: ${estado}\\n`;\n  \n  if (pedido.items && pedido.items.length > 0) {\n    mensaje += `ğŸ“¦ Productos:\\n`;\n    pedido.items.forEach(item => {\n      const precio = item.precio_unitario || item.precio || 0;\n      mensaje += `   â€¢ ${item.cantidad}x ${item.nombre} - $${parseFloat(precio).toFixed(2)}\\n`;\n    });\n  }\n  \n  if (pedido.estado === 'pendiente' || pedido.estado === 'confirmado') {\n    mensaje += `\\nâŒ Para cancelar: *cancelar pedido ${pedido.id}*\\n`;\n  }\n  \n  mensaje += `\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n`;\n  \n  if (index < pedidos.length - 1) {\n    mensaje += `\\n`;\n  }\n});\n\nmensaje += `\\nğŸ’¬ *Â¿Necesitas algo mÃ¡s?*\\n`;\nmensaje += `ğŸ“‹ Escribe *productos* para ver el catÃ¡logo\\n`;\nmensaje += `ğŸ“ Escribe *horarios* para ver nuestro horario`;\n\nconsole.log('âœ… Mensaje formateado correctamente');\n\nreturn {\n  json: {\n    numeroOrigen: switchData.numeroOrigen,\n    empresaId: switchData.empresaId,\n    nombreSesion: switchData.nombreSesion,\n    pushName: switchData.pushName,\n    mensaje: mensaje\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2272,
        1120
      ],
      "id": "e61d06c0-46f7-4607-8f97-56495b614b1a",
      "name": "Formatear pedidos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:3000/api/whatsapp/public/enviar-mensaje",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"empresaId\": {{ JSON.stringify($json.empresaId) }},\n  \"nombreSesion\": {{ JSON.stringify($json.nombreSesion || '') }},\n  \"numeroDestino\": {{ JSON.stringify($json.numeroOrigen || '') }},\n  \"mensaje\": {{ JSON.stringify($json.mensaje || '') }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4256,
        672
      ],
      "id": "f8fd3d18-e4de-4e24-bd62-6af656f18522",
      "name": "Enviar WhatsApp"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:3000/api/whatsapp/public/enviar-mensaje",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"empresaId\": {{ JSON.stringify($json.empresaId) }},\n  \"nombreSesion\": {{ JSON.stringify($json.nombreSesion || '') }},\n  \"numeroDestino\": {{ JSON.stringify($json.numeroOrigen || '') }},\n  \"mensaje\": {{ JSON.stringify($json.mensaje || '') }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2208,
        288
      ],
      "id": "b8aa203d-32df-4eb5-a597-66998a0a91ca",
      "name": "Enviar CatÃ¡logo Texto"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst productosConImagen = data.productosConImagen || [];\n\nif (productosConImagen.length === 0) {\n  return [];\n}\n\nconst items = productosConImagen.map((p, i) => {\n  return {\n    json: {\n      numeroOrigen: data.numeroOrigen,\n      empresaId: data.empresaId,\n      nombreSesion: data.nombreSesion,\n      imagenUrl: p.imagen_url,\n      caption: `*${p.numero}.* ${p.nombre}\\n${p.precio ? `ğŸ’° Precio: $${p.precio}\\n` : ''}${p.descripcion ? `ğŸ“ ${p.descripcion}` : ''}`,\n      orden: i\n    }\n  };\n});\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2192,
        464
      ],
      "id": "d7c0c487-2aaa-478e-b12a-0d0380f510ff",
      "name": "Preparar ImÃ¡genes"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2368,
        464
      ],
      "id": "ab27a948-bd38-4f80-9369-b2836d1d5ee8",
      "name": "Wait 3s",
      "webhookId": "8aa070f9-2b46-4c76-aa2b-d42047dd49dd"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:3000/api/whatsapp/public/enviar-imagen",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"empresaId\": {{ JSON.stringify($json.empresaId) }},\n  \"nombreSesion\": {{ JSON.stringify($json.nombreSesion || '') }},\n  \"numeroDestino\": {{ JSON.stringify($json.numeroOrigen || '') }},\n  \"imagenUrl\": {{ JSON.stringify($json.imagenUrl || '') }},\n  \"caption\": {{ JSON.stringify($json.caption || '') }}\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2544,
        464
      ],
      "id": "6b195d1b-fde1-471d-a0b6-29eb2d431186",
      "name": "Enviar Imagen Producto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:3000/api/pedidos/crear",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"empresaId\": {{ JSON.stringify($json.empresaId) }},\n  \"telefonoCliente\": {{ JSON.stringify($json.numeroOrigen) }},\n  \"nombreCliente\": {{ JSON.stringify($json.nombreCliente) }},\n  \"items\": {{ JSON.stringify($json.items) }},\n  \"total\": {{ $json.total }}\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2080,
        1584
      ],
      "id": "34903dc0-0e83-4fa7-9075-6714e13f82a4",
      "name": "Crear Pedido HTTP"
    },
    {
      "parameters": {
        "jsCode": "const crearResponse = $input.first().json;\nconst switchData = $('Switch').first().json;\n\nconsole.log('ğŸ“¥ Respuesta crear pedido:', JSON.stringify(crearResponse, null, 2));\n\nif (crearResponse.success) {\n  const pedido = crearResponse.data;\n  \n  try {\n    await fetch(`http://host.docker.internal:3000/api/pedidos/sesion/${switchData.empresaId}/${switchData.numeroOrigen}`, {\n      method: 'DELETE'\n    });\n  } catch (e) {\n    console.log('âš ï¸ Error al eliminar sesiÃ³n temporal:', e.message);\n  }\n  \n  let mensaje = `âœ… *Â¡Pedido confirmado!*\\n\\n`;\n  mensaje += `ğŸ“‹ *Pedido #${pedido.id}*\\n`;\n  mensaje += `ğŸ‘¤ Cliente: ${pedido.nombre_cliente}\\n`;\n  mensaje += `ğŸ’µ Total: $${parseFloat(pedido.total).toFixed(2)}\\n\\n`;\n  mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\n  mensaje += `ğŸ“¦ *Tu pedido ha sido registrado exitosamente*\\n\\n`;\n  mensaje += `Nos pondremos en contacto contigo pronto.\\n\\n`;\n  mensaje += `ğŸ’¬ Â¿Necesitas algo mÃ¡s?\\n`;\n  mensaje += `ğŸ“‹ Escribe *mis pedidos* para ver tu historial\\n`;\n  mensaje += `ğŸ›’ Escribe *productos* para hacer otro pedido`;\n  \n  return {\n    json: {\n      numeroOrigen: switchData.numeroOrigen,\n      empresaId: switchData.empresaId,\n      nombreSesion: switchData.nombreSesion,\n      mensaje: mensaje\n    }\n  };\n} else {\n  return {\n    json: {\n      numeroOrigen: switchData.numeroOrigen,\n      empresaId: switchData.empresaId,\n      nombreSesion: switchData.nombreSesion,\n      mensaje: `âŒ *Error al crear el pedido*\\n\\n${crearResponse.mensaje || 'Por favor intenta de nuevo'}\\n\\nğŸ“‹ Escribe *productos* para intentar de nuevo`\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2400,
        1584
      ],
      "id": "4b0873f3-f39e-4695-a0ed-dfbbb9bfab18",
      "name": "Formatear Pedido Creado"
    },
    {
      "parameters": {
        "url": "=http://host.docker.internal:3000/api/pedidos/detalle/{{ $json.pedidoId }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2080,
        1296
      ],
      "id": "a0e08a00-b1e6-49f0-8134-6a7187410a75",
      "name": "Obtener Detalle Pedido"
    },
    {
      "parameters": {
        "jsCode": "const switchData = $('Switch').first().json;\nconst detalleResponse = $input.first().json;\n\nconsole.log('ğŸ“¥ Respuesta detalle pedido:', JSON.stringify(detalleResponse, null, 2));\n\nif (!detalleResponse.success || !detalleResponse.data) {\n  console.log('âŒ Pedido no encontrado');\n  return {\n    json: {\n      numeroOrigen: switchData.numeroOrigen,\n      empresaId: switchData.empresaId,\n      nombreSesion: switchData.nombreSesion,\n      pushName: switchData.pushName,\n      mensaje: `âŒ *Pedido #${switchData.pedidoId} no encontrado*\\n\\nğŸ“‹ Escribe *mis pedidos* para ver tus pedidos activos.`,\n      esError: true\n    }\n  };\n}\n\nconst pedido = detalleResponse.data;\n\n// VALIDAR PROPIEDAD DEL PEDIDO\nif (pedido.telefono_cliente !== switchData.numeroOrigen) {\n  console.log('âš ï¸ TelÃ©fono no coincide');\n  return {\n    json: {\n      numeroOrigen: switchData.numeroOrigen,\n      empresaId: switchData.empresaId,\n      nombreSesion: switchData.nombreSesion,\n      pushName: switchData.pushName,\n      mensaje: `âŒ *No tienes permiso para cancelar este pedido*\\n\\nğŸ“‹ Escribe *mis pedidos* para ver tus pedidos.`,\n      esError: true\n    }\n  };\n}\n\n// VALIDAR ESTADO DEL PEDIDO\nif (pedido.estado === 'cancelado') {\n  return {\n    json: {\n      numeroOrigen: switchData.numeroOrigen,\n      empresaId: switchData.empresaId,\n      nombreSesion: switchData.nombreSesion,\n      pushName: switchData.pushName,\n      mensaje: `â„¹ï¸ *El pedido #${switchData.pedidoId} ya estÃ¡ cancelado*\\n\\nğŸ“‹ Escribe *mis pedidos* para ver tus otros pedidos.`,\n      esError: true\n    }\n  };\n}\n\nif (pedido.estado === 'entregado') {\n  return {\n    json: {\n      numeroOrigen: switchData.numeroOrigen,\n      empresaId: switchData.empresaId,\n      nombreSesion: switchData.nombreSesion,\n      pushName: switchData.pushName,\n      mensaje: `âŒ *No puedes cancelar el pedido #${switchData.pedidoId}*\\n\\nEl pedido ya fue entregado.\\n\\nğŸ“ Contacta con soporte si necesitas ayuda.`,\n      esError: true\n    }\n  };\n}\n\nif (pedido.estado === 'enviado' || pedido.estado === 'en_proceso') {\n  return {\n    json: {\n      numeroOrigen: switchData.numeroOrigen,\n      empresaId: switchData.empresaId,\n      nombreSesion: switchData.nombreSesion,\n      pushName: switchData.pushName,\n      mensaje: `âš ï¸ *El pedido #${switchData.pedidoId} ya estÃ¡ en camino*\\n\\nNo puede ser cancelado automÃ¡ticamente.\\n\\nğŸ“ Contacta con soporte para cancelarlo.`,\n      esError: true\n    }\n  };\n}\n\n// TODO OK - Pasar al siguiente nodo para cancelar\nreturn {\n  json: {\n    numeroOrigen: switchData.numeroOrigen,\n    empresaId: switchData.empresaId,\n    nombreSesion: switchData.nombreSesion,\n    pushName: switchData.pushName,\n    pedidoId: switchData.pedidoId,\n    pedidoData: pedido,\n    esError: false\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2272,
        1296
      ],
      "id": "f2b790c4-256d-46a8-8f40-450472568e6e",
      "name": "Validar Pedido"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-error",
              "leftValue": "={{ $json.esError }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "false"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2464,
        1296
      ],
      "id": "7798389f-884f-41b7-a484-61d0f156ffa1",
      "name": "If ValidaciÃ³n OK"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=http://host.docker.internal:3000/api/pedidos/{{ $json.pedidoId }}/cancelar",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"empresaId\": {{ JSON.stringify($json.empresaId) }},\n  \"telefono\": {{ JSON.stringify($json.numeroOrigen) }}\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2736,
        1200
      ],
      "id": "c9c19c81-8985-453a-aaff-73ec9412c766",
      "name": "Cancelar Pedido HTTP"
    },
    {
      "parameters": {
        "jsCode": "const cancelResponse = $input.first().json;\nconst validarData = $('Validar Pedido').first().json;\n\nconsole.log('ğŸ“¥ Respuesta cancelaciÃ³n:', JSON.stringify(cancelResponse, null, 2));\n\nif (cancelResponse.success) {\n  console.log('âœ… Pedido cancelado exitosamente');\n  \n  const total = validarData.pedidoData.total || 0;\n  \n  return {\n    json: {\n      numeroOrigen: validarData.numeroOrigen,\n      empresaId: validarData.empresaId,\n      nombreSesion: validarData.nombreSesion,\n      pushName: validarData.pushName,\n      mensaje: `âœ… *Pedido #${validarData.pedidoId} cancelado exitosamente*\\n\\nğŸ’µ Total cancelado: $${parseFloat(total).toFixed(2)}\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\nğŸ“‹ Escribe *pedidos* para ver tu historial\\nğŸ›’ Escribe *productos* para hacer un nuevo pedido`\n    }\n  };\n} else {\n  console.error('âŒ Error en cancelaciÃ³n:', cancelResponse.mensaje);\n  return {\n    json: {\n      numeroOrigen: validarData.numeroOrigen,\n      empresaId: validarData.empresaId,\n      nombreSesion: validarData.nombreSesion,\n      pushName: validarData.pushName,\n      mensaje: `âŒ *Error al cancelar el pedido #${validarData.pedidoId}*\\n\\n${cancelResponse.mensaje || 'Por favor intenta de nuevo'}`\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2960,
        1200
      ],
      "id": "4d129684-4d62-44bd-b861-f33cee9ab1f2",
      "name": "Formatear Respuesta CancelaciÃ³n"
    },
    {
      "parameters": {
        "jsCode": "const validarData = $input.first().json;\n\nreturn {\n  json: {\n    numeroOrigen: validarData.numeroOrigen,\n    empresaId: validarData.empresaId,\n    nombreSesion: validarData.nombreSesion,\n    pushName: validarData.pushName,\n    mensaje: validarData.mensaje\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2768,
        1392
      ],
      "id": "72d2ebd4-a08c-42f2-adb6-e854c625a3a7",
      "name": "Pasar Error"
    },
    {
      "parameters": {
        "content": "Flujo inicial",
        "height": 496,
        "width": 1232,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -80,
        16
      ],
      "typeVersion": 1,
      "id": "6288d0ad-38e6-475a-8ec7-79a0c9d6e05d",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "Flujo para pymes de productos y pedidos",
        "height": 1680,
        "width": 2272,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1616,
        128
      ],
      "typeVersion": 1,
      "id": "6b0a2842-70ee-43e9-9c7a-3df88563f35f",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "Validar y clasificar los mensajes",
        "height": 208
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        944,
        640
      ],
      "typeVersion": 1,
      "id": "9653bbb2-2b44-4d2c-aca0-5ae476929f7f",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "Switch principal\n",
        "height": 560,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1280,
        496
      ],
      "typeVersion": 1,
      "id": "5c0416fc-c89b-4342-b174-907aec9698ae",
      "name": "Sticky Note3"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Validar y Clasificar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar y Clasificar": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Mostrar Horario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener productos catÃ¡logo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener productos pedido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respuesta Directa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Saludo Inicial",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener pedidos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Crear Pedido HTTP",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener Detalle Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener productos catÃ¡logo": {
      "main": [
        [
          {
            "node": "Formatear catÃ¡logo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear catÃ¡logo": {
      "main": [
        [
          {
            "node": "Enviar CatÃ¡logo Texto",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar ImÃ¡genes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar ImÃ¡genes": {
      "main": [
        [
          {
            "node": "Wait 3s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 3s": {
      "main": [
        [
          {
            "node": "Enviar Imagen Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Imagen Producto": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Saludo Inicial": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta Directa": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mostrar Horario": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener pedidos": {
      "main": [
        [
          {
            "node": "Formatear pedidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear pedidos": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Groq Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Obtener productos pedido": {
      "main": [
        [
          {
            "node": "Procesar pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar pedido": {
      "main": [
        [
          {
            "node": "Formatear pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear pedido": {
      "main": [
        [
          {
            "node": "Guardar SesiÃ³n Temporal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar SesiÃ³n Temporal": {
      "main": [
        [
          {
            "node": "Recuperar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recuperar": {
      "main": [
        [
          {
            "node": "If horario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If horario": {
      "main": [
        [
          {
            "node": "Preparar whatsapp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje Pedido Fuera Horario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar whatsapp": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Pedido Fuera Horario": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Pedido HTTP": {
      "main": [
        [
          {
            "node": "Formatear Pedido Creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Pedido Creado": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Detalle Pedido": {
      "main": [
        [
          {
            "node": "Validar Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Pedido": {
      "main": [
        [
          {
            "node": "If ValidaciÃ³n OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If ValidaciÃ³n OK": {
      "main": [
        [
          {
            "node": "Cancelar Pedido HTTP",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pasar Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar Pedido HTTP": {
      "main": [
        [
          {
            "node": "Formatear Respuesta CancelaciÃ³n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta CancelaciÃ³n": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pasar Error": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "133e94b8-504c-4eb9-9153-bb7bdff3d473",
  "meta": {
    "instanceId": "06f3abd0c47bf03702da44aaccc72833bb792a76d9bfba39d8fccc46f2369aad"
  },
  "id": "CDZ9N8XD88P29do1",
  "tags": []
}